<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSearch Security Demo â€” RBAC, Cell & NTK</title>
    <script src="https://cdn.jsdelivr.net/npm/keycloak-js@24.0.0/dist/keycloak.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2236;
            --border: #1e3a5f;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --unclassified: #22c55e;
            --confidential: #3b82f6;
            --secret: #ef4444;
            --top-secret: #f59e0b;
            --redacted: #991b1b;
            --redacted-bg: #450a0a;
            --ntk-color: #a855f7;
            --ntk-bg: #581c87;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Header */
        .app-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .app-header h1 {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .app-header h1 span { color: var(--accent); }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        .auth-status.authenticated {
            border-color: var(--success);
            color: var(--success);
        }
        .auth-status.demo {
            border-color: var(--warning);
            color: var(--warning);
        }

        .auth-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .auth-btn.login {
            background: var(--accent);
            color: white;
        }
        .auth-btn.login:hover { background: #4f46e5; }
        .auth-btn.logout {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .auth-btn.logout:hover { border-color: var(--danger); color: var(--danger); }

        /* Tabs */
        .tab-nav {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            gap: 4px;
        }
        .tab-btn {
            padding: 14px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .tab-btn.ntk-tab.active {
            color: var(--ntk-color);
            border-bottom-color: var(--ntk-color);
        }

        /* Main Content */
        .main-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* User Profile */
        .user-profile {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .profile-field {
            margin-bottom: 12px;
        }
        .profile-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .profile-value {
            font-size: 14px;
            color: var(--text-primary);
        }

        /* User Selector */
        .user-selector {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
        }
        .user-selector select {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            flex: 1;
            max-width: 400px;
        }
        .user-selector select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Search */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .search-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .search-btn {
            padding: 12px 24px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-btn:hover { background: #4f46e5; }
        .search-btn.ntk { background: var(--ntk-color); }
        .search-btn.ntk:hover { background: #9333ea; }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .stat-value.visible { color: var(--success); }
        .stat-value.hidden { color: var(--danger); }
        .stat-value.ntk { color: var(--ntk-color); }

        /* Classification Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }
        .badge-UNCLASSIFIED { background: #052e16; color: var(--unclassified); border: 1px solid #166534; }
        .badge-CONFIDENTIAL { background: #0c1e3d; color: var(--confidential); border: 1px solid #1e40af; }
        .badge-SECRET { background: #2d0a0a; color: var(--secret); border: 1px solid #991b1b; }
        .badge-TOP_SECRET { background: #2d1f04; color: var(--top-secret); border: 1px solid #92400e; }
        .badge-NTK { background: var(--ntk-bg); color: var(--ntk-color); border: 1px solid #7c3aed; }

        /* Cell Badges */
        .cell-badge {
            display: inline-flex;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            background: #1e3a5f;
            color: #7dd3fc;
            margin-right: 4px;
        }

        /* Document Cards */
        .doc-grid {
            display: grid;
            gap: 16px;
        }
        .doc-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: border-color 0.2s;
        }
        .doc-card:hover { border-color: var(--accent); }
        .doc-card.ntk-restricted {
            border-color: var(--ntk-color);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(88, 28, 135, 0.1) 100%);
        }
        .doc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .doc-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .doc-meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        .doc-content {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 12px;
        }
        .doc-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        /* Sensitive Fields */
        .sensitive-fields {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .field-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .field-label {
            color: var(--text-muted);
            min-width: 100px;
        }
        .field-value {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
        .field-value.redacted {
            color: #ef4444;
            background: var(--redacted-bg);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .field-value.cell-denied {
            color: #f97316;
            background: #431407;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .field-value.ntk-denied {
            color: var(--ntk-color);
            background: var(--ntk-bg);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* NTK Status Indicator */
        .ntk-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 4px;
            background: rgba(168, 85, 247, 0.15);
            color: var(--ntk-color);
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        .ntk-indicator.granted { 
            background: rgba(16, 185, 129, 0.15); 
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.3);
        }

        /* Compare Grid */
        .compare-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .compare-column {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }
        .compare-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .compare-title {
            font-size: 14px;
            font-weight: 700;
        }
        .compare-title.rbac { color: var(--confidential); }
        .compare-title.cell { color: var(--warning); }
        .compare-title.ntk { color: var(--ntk-color); }
        .compare-count {
            font-size: 20px;
            font-weight: 700;
        }

        /* Filter Explanation */
        .filter-explanation {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 16px;
            border-left: 3px solid var(--accent);
        }
        .filter-explanation.ntk { border-left-color: var(--ntk-color); }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 60px);
            gap: 24px;
        }
        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
        }
        .login-card h2 {
            font-size: 24px;
            margin-bottom: 12px;
        }
        .login-card p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        .login-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .btn-keycloak {
            padding: 14px 28px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-keycloak:hover { background: #4f46e5; }
        .btn-demo {
            padding: 14px 28px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-demo:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        /* Reset Button */
        .reset-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--danger);
            border-radius: 6px;
            color: var(--danger);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .reset-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .compare-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .user-profile { grid-template-columns: 1fr; }
            .stats-row { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Keycloak Configuration
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const KEYCLOAK_URL = 'http://localhost:8080';
        const KEYCLOAK_REALM = 'agency-alpha';
        const KEYCLOAK_CLIENT_ID = 'frontend-app';

        let keycloak = null;
        let isAuthenticated = false;
        let authToken = null;

        async function initKeycloak() {
            try {
                keycloak = new Keycloak({
                    url: KEYCLOAK_URL,
                    realm: KEYCLOAK_REALM,
                    clientId: KEYCLOAK_CLIENT_ID
                });

                const authenticated = await keycloak.init({
                    onLoad: 'check-sso',
                    silentCheckSsoRedirectUri: window.location.origin + '/silent-check-sso.html',
                    checkLoginIframe: false
                });

                isAuthenticated = authenticated;
                if (authenticated) {
                    authToken = keycloak.token;
                    console.log('Authenticated as:', keycloak.tokenParsed?.preferred_username);
                    
                    // Auto-refresh token
                    setInterval(async () => {
                        try {
                            const refreshed = await keycloak.updateToken(30);
                            if (refreshed) {
                                authToken = keycloak.token;
                            }
                        } catch (e) {
                            console.warn('Token refresh failed:', e);
                        }
                    }, 30000);
                }

                return authenticated;
            } catch (error) {
                console.warn('Keycloak init failed:', error);
                return false;
            }
        }

        function login() {
            if (keycloak) {
                keycloak.login();
            }
        }

        function logout() {
            if (keycloak && isAuthenticated) {
                keycloak.logout({ redirectUri: window.location.origin });
            } else {
                // Demo mode - just refresh
                window.location.reload();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // API Functions
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const response = await fetch(endpoint, {
                ...options,
                headers
            });
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            return response.json();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Application State & Rendering
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const state = {
            initialized: false,
            demoMode: false,
            showLoginScreen: true,
            activeTab: 'rbac',
            users: {},
            selectedUserId: 'alpha-analyst',
            currentUser: null,
            searchQuery: '',
            searchResults: null,
            compareResults: null,
            loading: false
        };

        function setState(updates) {
            Object.assign(state, updates);
            render();
        }

        async function initApp() {
            const authenticated = await initKeycloak();
            
            if (authenticated) {
                // Fetch current user profile
                const me = await apiCall('/api/me');
                setState({
                    initialized: true,
                    showLoginScreen: false,
                    currentUser: me.profile,
                    demoMode: false
                });
                await doSearch();
            } else {
                // Show login screen
                const users = await apiCall('/api/users');
                setState({
                    initialized: true,
                    users: users,
                    showLoginScreen: true
                });
            }
        }

        async function enterDemoMode() {
            const users = await apiCall('/api/users');
            const me = await apiCall(`/api/me?user_id=${state.selectedUserId}`);
            setState({
                showLoginScreen: false,
                demoMode: true,
                users: users,
                currentUser: me.profile
            });
            await doSearch();
        }

        async function selectUser(userId) {
            setState({ selectedUserId: userId, loading: true });
            const me = await apiCall(`/api/me?user_id=${userId}`);
            setState({ currentUser: me.profile, loading: false });
            await doSearch();
        }

        async function doSearch() {
            setState({ loading: true });
            
            try {
                if (state.activeTab === 'compare') {
                    const results = await apiCall('/api/compare', {
                        method: 'POST',
                        body: JSON.stringify({
                            query: state.searchQuery,
                            user_id: state.demoMode ? state.selectedUserId : ''
                        })
                    });
                    setState({ compareResults: results, loading: false });
                } else {
                    const results = await apiCall('/api/search', {
                        method: 'POST',
                        body: JSON.stringify({
                            query: state.searchQuery,
                            user_id: state.demoMode ? state.selectedUserId : '',
                            mode: state.activeTab
                        })
                    });
                    setState({ searchResults: results, loading: false });
                }
            } catch (error) {
                console.error('Search error:', error);
                setState({ loading: false });
            }
        }

        async function resetIndex() {
            if (!confirm('Reset index to seed data?')) return;
            setState({ loading: true });
            await apiCall('/api/reset', { method: 'POST' });
            await doSearch();
        }

        function changeTab(tab) {
            setState({ activeTab: tab, searchResults: null, compareResults: null });
            doSearch();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Render Functions
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderLoginScreen() {
            return `
                <div class="login-screen">
                    <div class="login-card">
                        <h2>ğŸ” OpenSearch Security Demo</h2>
                        <p>RBAC, Cell-Level & Need-to-Know (NTK) Access Control</p>
                        <div class="login-actions">
                            <button class="btn-keycloak" onclick="login()">
                                ğŸ”‘ Login with Keycloak
                            </button>
                            <button class="btn-demo" onclick="enterDemoMode()">
                                âš ï¸ Continue in Demo Mode
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            const authStatus = state.demoMode 
                ? '<div class="auth-status demo">âš ï¸ Demo Mode</div>'
                : '<div class="auth-status authenticated">ğŸ”‘ Authenticated</div>';

            const authButton = (state.demoMode || isAuthenticated)
                ? '<button class="auth-btn logout" onclick="logout()">Logout</button>'
                : '<button class="auth-btn login" onclick="login()">Login</button>';

            return `
                <header class="app-header">
                    <h1>ğŸ” <span>OpenSearch</span> Security Demo</h1>
                    <div class="header-right">
                        ${authStatus}
                        ${authButton}
                    </div>
                </header>
            `;
        }

        function renderTabs() {
            const tabs = [
                { id: 'rbac', label: 'ğŸ” RBAC' },
                { id: 'cell', label: 'ğŸ¢ Cell-Level' },
                { id: 'ntk', label: 'ğŸ”’ NTK', isNtk: true },
                { id: 'compare', label: 'âš–ï¸ Compare All' }
            ];

            return `
                <nav class="tab-nav">
                    ${tabs.map(t => `
                        <button class="tab-btn ${t.isNtk ? 'ntk-tab' : ''} ${state.activeTab === t.id ? 'active' : ''}"
                            onclick="changeTab('${t.id}')">
                            ${t.label}
                        </button>
                    `).join('')}
                </nav>
            `;
        }

        function renderUserSelector() {
            if (!state.demoMode) return '';
            
            const options = Object.entries(state.users).map(([id, user]) => 
                `<option value="${id}" ${state.selectedUserId === id ? 'selected' : ''}>
                    ${user.name} â€” ${user.clearance}
                </option>`
            ).join('');

            return `
                <div class="user-selector">
                    <label>Demo User:</label>
                    <select onchange="selectUser(this.value)" ${!state.demoMode ? 'disabled' : ''}>
                        ${options}
                    </select>
                </div>
            `;
        }

        function renderUserProfile() {
            const user = state.currentUser;
            if (!user) return '';

            const cells = (user.cell_memberships || []).map(c => 
                `<span class="cell-badge">${c}</span>`
            ).join('') || '<span class="text-muted">None</span>';

            const compartments = (user.compartments || []).map(c =>
                `<span class="badge badge-NTK">${c}</span>`
            ).join('') || '<span class="text-muted">None</span>';

            const roles = (user.roles || []).map(r =>
                `<span class="cell-badge">${r}</span>`
            ).join('');

            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ‘¤ Current User Profile</div>
                        <span class="badge badge-${user.clearance}">${user.clearance}</span>
                    </div>
                    <div class="user-profile">
                        <div>
                            <div class="profile-field">
                                <div class="profile-label">Username</div>
                                <div class="profile-value mono">${user.username}</div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-label">Name</div>
                                <div class="profile-value">${user.name}</div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-label">Organization</div>
                                <div class="profile-value">${user.organization}</div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-label">Roles</div>
                                <div class="profile-value">${roles}</div>
                            </div>
                        </div>
                        <div>
                            <div class="profile-field">
                                <div class="profile-label">Cell Memberships</div>
                                <div class="profile-value">${cells}</div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-label">Compartments (NTK)</div>
                                <div class="profile-value">${compartments}</div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-label">Description</div>
                                <div class="profile-value" style="color: var(--text-muted)">${user.description || ''}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSearchBar() {
            const isNtk = state.activeTab === 'ntk';
            return `
                <div class="search-bar">
                    <input type="text" 
                        class="search-input" 
                        placeholder="Search documents..."
                        value="${state.searchQuery}"
                        onkeyup="if(event.key==='Enter') doSearch()"
                        oninput="state.searchQuery = this.value">
                    <button class="search-btn ${isNtk ? 'ntk' : ''}" onclick="doSearch()">
                        Search
                    </button>
                    <button class="reset-btn" onclick="resetIndex()">
                        â†º Reset Data
                    </button>
                </div>
            `;
        }

        function renderDocumentCard(doc, mode) {
            const isNtkRestricted = doc.ntk_required;
            const ntkStatus = doc._ntk_status;
            
            let ntkIndicator = '';
            if (mode === 'ntk' && isNtkRestricted) {
                const reason = ntkStatus?.reason || 'unknown';
                const granted = ntkStatus?.has_access;
                const reasonText = reason === 'explicit_user' ? 'Named User' :
                                   reason === 'compartment_match' ? 'Compartment Match' :
                                   reason === 'not_required' ? '' : 'Denied';
                if (granted && reasonText) {
                    ntkIndicator = `<span class="ntk-indicator granted">âœ“ NTK: ${reasonText}</span>`;
                }
            }

            const sensitiveFields = ['source_name', 'handler_id', 'raw_intel'];
            const fieldAccess = doc._field_access || {};
            
            const fieldsHtml = sensitiveFields.map(field => {
                const value = doc[field] || '';
                if (!value) return '';
                
                const access = fieldAccess[field] || 'visible';
                let valueClass = '';
                if (access === 'redacted') valueClass = 'redacted';
                else if (access === 'cell_denied') valueClass = 'cell-denied';
                else if (access === 'ntk_denied') valueClass = 'ntk-denied';

                const label = field.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                return `
                    <div class="field-row">
                        <span class="field-label">${label}:</span>
                        <span class="field-value ${valueClass}">${value}</span>
                    </div>
                `;
            }).filter(h => h).join('');

            const cellBadges = (doc.cell_access || []).map(c => 
                `<span class="cell-badge">${c}</span>`
            ).join('');

            return `
                <div class="doc-card ${isNtkRestricted ? 'ntk-restricted' : ''}">
                    <div class="doc-header">
                        <div>
                            <div class="doc-title">${doc.title}</div>
                            <div class="doc-meta">${doc.author} â€¢ ${doc.date_created} â€¢ ${doc.location || 'Unknown'}</div>
                        </div>
                        <span class="badge badge-${doc.classification}">${doc.classification}</span>
                    </div>
                    <div class="doc-content">${doc.content}</div>
                    <div class="doc-badges">
                        ${cellBadges}
                        ${isNtkRestricted ? '<span class="badge badge-NTK">NTK Required</span>' : ''}
                        ${ntkIndicator}
                    </div>
                    ${fieldsHtml ? `<div class="sensitive-fields">${fieldsHtml}</div>` : ''}
                </div>
            `;
        }

        function renderSearchResults() {
            const results = state.searchResults;
            if (!results) return '<div class="loading">Run a search to see results</div>';
            if (state.loading) return '<div class="loading">Loading...</div>';

            const isNtk = state.activeTab === 'ntk';
            
            return `
                <div class="filter-explanation ${isNtk ? 'ntk' : ''}">
                    ${results.filter_explanation}
                </div>
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">Total in Index</div>
                        <div class="stat-value">${results.total_in_index}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Visible to You</div>
                        <div class="stat-value visible">${results.visible_count}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Hidden</div>
                        <div class="stat-value hidden">${results.hidden_count}</div>
                    </div>
                </div>
                <div class="doc-grid">
                    ${results.documents.map(doc => renderDocumentCard(doc, state.activeTab)).join('')}
                </div>
            `;
        }

        function renderCompareResults() {
            const results = state.compareResults;
            if (!results) return '<div class="loading">Run a search to compare modes</div>';
            if (state.loading) return '<div class="loading">Loading...</div>';

            function renderColumn(mode, data, title, colorClass) {
                return `
                    <div class="compare-column">
                        <div class="compare-header">
                            <span class="compare-title ${colorClass}">${title}</span>
                            <span class="compare-count">${data.visible}</span>
                        </div>
                        <div class="doc-grid">
                            ${data.documents.slice(0, 10).map(doc => renderDocumentCard(doc, mode)).join('')}
                        </div>
                        ${data.documents.length > 10 ? `<div style="text-align:center;padding:12px;color:var(--text-muted)">+${data.documents.length - 10} more</div>` : ''}
                    </div>
                `;
            }

            return `
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">Total Documents</div>
                        <div class="stat-value">${results.total_in_index}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">RBAC Visible</div>
                        <div class="stat-value">${results.rbac.visible}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Cell-Level Visible</div>
                        <div class="stat-value">${results.cell.visible}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">NTK Visible</div>
                        <div class="stat-value ntk">${results.ntk.visible}</div>
                    </div>
                </div>
                <div class="compare-grid">
                    ${renderColumn('rbac', results.rbac, 'ğŸ” RBAC Mode', 'rbac')}
                    ${renderColumn('cell', results.cell, 'ğŸ¢ Cell-Level Mode', 'cell')}
                    ${renderColumn('ntk', results.ntk, 'ğŸ”’ NTK Mode', 'ntk')}
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.initialized) {
                app.innerHTML = '<div class="loading">Initializing...</div>';
                return;
            }

            if (state.showLoginScreen) {
                app.innerHTML = `
                    ${renderHeader()}
                    ${renderLoginScreen()}
                `;
                return;
            }

            const content = state.activeTab === 'compare' 
                ? renderCompareResults() 
                : renderSearchResults();

            app.innerHTML = `
                ${renderHeader()}
                ${renderTabs()}
                <div class="main-content">
                    ${renderUserSelector()}
                    ${renderUserProfile()}
                    ${renderSearchBar()}
                    ${content}
                </div>
            `;
        }

        // Initialize
        render();
        initApp().catch(console.error);
    </script>
</body>
</html>
